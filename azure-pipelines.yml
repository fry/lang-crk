# This is an azure pipelines configuration generated by the script found at
# https://github.com/divvun/divvun-ci-config/azure/generate-speller.sh
# YOU SHOULD NOT EDIT THIS MANUALLY 
# Script commit 8847f9b62b1f11b836934c55e8312402e87a6299
# Generated on 20190611081633

trigger:
- master

jobs:
- job: 'macOS'
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - script: |
      set -e
      git clone https://github.com/divvun/divvun-ci-config.git
      cd divvun-ci-config
      sh ./install-macos.sh
      wget https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat-macos -O pahkat
      chmod +x pahkat
      wget https://github.com/divvun/divvun-bundler/releases/download/0.1.0/divvun-bundler-mso-macos -O divvun-bundler
      chmod +x divvun-bundler
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - script: |
      set -e
      export PATH="$PATH:$(System.DefaultWorkingDirectory)/divvun-ci-config"
      export DEPLOY_VERSION=$(cat version.txt | xargs)
      sh divvun-ci-config/repo/scripts/download_speller.sh https://apertium.projectjj.com/apt/nightly/pool/main/g/giella-crk/ usr/share/voikko/3/crk.zhfst crk.zhfst
      divvun-bundler -R -t osx -H "Plains Cree Speller" -V $DEPLOY_VERSION speller -l crk -a "Developer ID Application: The University of Tromso (2K5J2584NX)" -i "Developer ID Installer: The University of Tromso (2K5J2584NX)" -z crk.zhfst
      mv no.divvun.MacDivvun.crk-$DEPLOY_VERSION.pkg speller-crk.pkg
    displayName: 'Build'
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/speller-crk.pkg'
      artifactName: macos
  - script: |
      set -e
      export PATH="$PATH:$(System.DefaultWorkingDirectory)/divvun-ci-config"
      export DEPLOY_VERSION=$(cat version.txt | xargs)
      sh divvun-ci-config/repo/scripts/pahkat_deploy_svn.sh https://pahkat.uit.no/repo/macos "$(pwd)/speller-crk.pkg" speller-crk $DEPLOY_VERSION
    displayName: 'Deploy to nightly channel'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
- job: 'macOS_libreoffice'
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - script: |
      set -e
      git clone https://github.com/divvun/divvun-ci-config.git
      cd divvun-ci-config
      sh ./install-macos.sh
      wget https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat-macos -O pahkat
      chmod +x pahkat
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - script: |
      set -e
      export PATH="$PATH:$(System.DefaultWorkingDirectory)/divvun-ci-config"
      export DEPLOY_VERSION=$(cat version.txt | xargs)
      sh divvun-ci-config/repo/scripts/download_speller.sh https://apertium.projectjj.com/apt/nightly/pool/main/g/giella-crk/ usr/share/voikko/3/crk.zhfst crk.zhfst
      sh divvun-ci-config/repo/scripts/generate_dist.sh "Plains Cree Speller LibreOffice" no.uit.spellers.libreoffice.crk speller-crk-lo.pkg > dist.xml
      mkdir -p crk/etc/voikko/3
      mv crk.zhfst crk/etc/voikko/3
      pkgbuild --root crk --ownership recommended --version $DEPLOY_VERSION --identifier no.uit.spellers.libreoffice.crk speller-crk-lo.pkg
      productbuild --distribution dist.xml --version $DEPLOY_VERSION --package-path build speller-crk-lo.unsigned.pkg
      productsign --sign "Developer ID Installer: The University of Tromso (2K5J2584NX)" speller-crk-lo.unsigned.pkg speller-crk-lo.pkg
      pkgutil --check-signature speller-crk-lo.pkg
    displayName: 'Build'
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/speller-crk-lo.pkg'
      artifactName: macos
  - script: |
      set -e
      export PATH="$PATH:$(System.DefaultWorkingDirectory)/divvun-ci-config"
      export DEPLOY_VERSION=$(cat version.txt | xargs)
      sh divvun-ci-config/repo/scripts/pahkat_deploy_svn.sh https://pahkat.uit.no/repo/macos "$(pwd)/speller-crk-lo.pkg" speller-crk-lo $DEPLOY_VERSION
    displayName: 'Deploy to nightly channel'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
- job: 'Windows'
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - bash: |
      set -e
      curl -sLo LockedList.zip https://nsis.sourceforge.io/mediawiki/images/d/d3/LockedList.zip
      unzip LockedList.zip "Plugins/*" -d "C:\Program Files (x86)\NSIS" -q
      unzip LockedList.zip "Plugins/x86-ansi/*" -d "C:\Program Files (x86)\NSIS" -q
      unzip LockedList.zip "Plugins/x86-unicode/*" -d "C:\Program Files (x86)\NSIS" -q
      curl -sLo pahkat.exe https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat.exe
      curl -sLo divvun-bundler.exe https://github.com/divvun/divvun-bundler/releases/download/0.1.0/divvun-bundler.exe
      git clone https://github.com/divvun/divvun-ci-config.git
      openssl aes-256-cbc -d -in ./divvun-ci-config/config.txz.enc -pass pass:$DIVVUN_KEY -out config.txz -md md5
      7z e config.txz
      tar xf config.tar
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - powershell: |
      $Env:PATH += ";C:\Program Files (x86)\Microsoft SDKs\ClickOnce\SignTool"
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      $version = [IO.File]::ReadAllText(".\version.txt").Trim()
      . .\divvun-ci-config\repo\scripts\DownloadSpeller.ps1
      DownloadSpeller -From "https://apertium.projectjj.com/apt/nightly/pool/main/g/giella-crk" -Match "^giella-crk_.*\.deb$" -SourceFile ".\usr\share\voikko\3\crk.zhfst" -OutFile "crk.zhfst"
      divvun-bundler -R -t win --uuid "{82C350D0-E688-4CBB-BDCE-54F3E6B956D7}" -H "Plains Cree Speller" -V $version -c .\enc\creds\windows\divvun.pfx speller -l crk -z crk.zhfst
      Rename-Item -Path "crk-$version.exe" -NewName "speller-crk.exe"
    displayName: 'Build'
    env:
      SIGN_PFX_PASSWORD: $(pfxPassword)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/speller-crk.exe'
      artifactName: windows
  - powershell: |
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      $version = [IO.File]::ReadAllText(".\version.txt").Trim()
      . .\divvun-ci-config\repo\scripts\PahkatDeploySvn.ps1
      PahkatDeploySvn -SvnUrl https://pahkat.uit.no/repo/windows -Artifact "$(System.DefaultWorkingDirectory)\speller-crk.exe" -Package speller-crk -Version $version
    displayName: 'Deploy to nightly channel'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
- job: 'Windows_libreoffice'
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - bash: |
      set -e
      curl -sLo pahkat.exe https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat.exe
      git clone https://github.com/divvun/divvun-ci-config.git
      openssl aes-256-cbc -d -in ./divvun-ci-config/config.txz.enc -pass pass:$DIVVUN_KEY -out config.txz -md md5
      7z e config.txz
      tar xf config.tar
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - powershell: |
      $version = [IO.File]::ReadAllText(".\version.txt").Trim()
      . .\divvun-ci-config\repo\scripts\DownloadSpeller.ps1
      . .\divvun-ci-config\repo\scripts\BundleLibreOffice.ps1
      DownloadSpeller -From "https://apertium.projectjj.com/apt/nightly/pool/main/g/giella-crk" -Match "^giella-crk_.*\.deb$" -SourceFile ".\usr\share\voikko\3\crk.zhfst" -OutFile "crk.zhfst"
      GenerateSpellerSetup -Name "Plains Cree Speller LibreOffice" -UUID "55004AE6-7CA6-4969-AD11-2BD4D0E6C92A" -Version $version -LanguageTag "crk"
      InvokeIscc -IssFile .\setup.iss -PfxPath "$(System.DefaultWorkingDirectory)\enc\creds\windows\divvun.pfx" -PfxPassword $Env:CODESIGN_PW
    displayName: 'Build'
    env:
      CODESIGN_PW: $(pfxPassword)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/output/speller-crk-lo.exe'
      artifactName: windows
  - powershell: |
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      $version = [IO.File]::ReadAllText(".\version.txt").Trim()
      . .\divvun-ci-config\repo\scripts\PahkatDeploySvn.ps1
      PahkatDeploySvn -SvnUrl https://pahkat.uit.no/repo/windows -Artifact "$(System.DefaultWorkingDirectory)\output\speller-crk-lo.exe" -Package speller-crk-lo -Version $version
    displayName: 'Deploy to nightly channel'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
- job: 'Windows_msoffice'
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - bash: |
      set -e
      curl -sLo LockedList.zip https://nsis.sourceforge.io/mediawiki/images/d/d3/LockedList.zip
      unzip LockedList.zip "Plugins/*" -d "C:\Program Files (x86)\NSIS" -q
      unzip LockedList.zip "Plugins/x86-ansi/*" -d "C:\Program Files (x86)\NSIS" -q
      unzip LockedList.zip "Plugins/x86-unicode/*" -d "C:\Program Files (x86)\NSIS" -q
      curl -sLo pahkat.exe https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat.exe
      curl -sLo win-reg-tool.exe https://github.com/fry/win-reg-tool/releases/download/0.1.3/win-reg-tool.exe
      curl -sLo divvun-bundler.exe https://github.com/divvun/divvun-bundler/releases/download/0.1.0/divvun-bundler.exe
      git clone https://github.com/divvun/divvun-ci-config.git
      openssl aes-256-cbc -d -in ./divvun-ci-config/config.txz.enc -pass pass:$DIVVUN_KEY -out config.txz -md md5
      7z e config.txz
      tar xf config.tar
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - powershell: |
      $Env:PATH += ";C:\Program Files (x86)\Microsoft SDKs\ClickOnce\SignTool"
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      $version = [IO.File]::ReadAllText(".\version.txt").Trim()
      . .\divvun-ci-config\repo\scripts\DownloadSpeller.ps1
      DownloadSpeller -From "https://apertium.projectjj.com/apt/nightly/pool/main/g/giella-crk" -Match "^giella-crk_.*\.deb$" -SourceFile ".\usr\share\voikko\3\crk.zhfst" -OutFile "crk.zhfst"
      divvun-bundler -R -c .\enc\creds\windows\divvun.pfx -V $version --uuid "{9C5A39A8-B1C4-4A18-B53F-C28AF989B378}" -H "Plains Cree Speller MSOffice" -t win speller_mso --reg .\win-reg-tool.exe -l crk
      Rename-Item -Path "crk-mso-$version.exe" -NewName "speller-crk-mso.exe"
    displayName: 'Build'
    env:
      SIGN_PFX_PASSWORD: $(pfxPassword)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/speller-crk-mso.exe'
      artifactName: windows
  - powershell: |
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      $version = [IO.File]::ReadAllText(".\version.txt").Trim()
      . .\divvun-ci-config\repo\scripts\PahkatDeploySvn.ps1
      PahkatDeploySvn -SvnUrl https://pahkat.uit.no/repo/windows -Artifact "$(System.DefaultWorkingDirectory)\speller-crk-mso.exe" -Package speller-crk-mso -Version $version
    displayName: 'Deploy to nightly channel'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
